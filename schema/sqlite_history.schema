-- 履歴DB スキーマ定義
-- items, price_history, events テーブルおよびインデックス

CREATE TABLE IF NOT EXISTS items(
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    item_key        TEXT NOT NULL UNIQUE,
    url             TEXT,
    name            TEXT NOT NULL,
    store           TEXT NOT NULL,
    thumb_url       TEXT,
    search_keyword  TEXT,
    search_cond     TEXT,
    created_at      TIMESTAMP DEFAULT(DATETIME('now','localtime')),
    updated_at      TIMESTAMP DEFAULT(DATETIME('now','localtime'))
);

CREATE TABLE IF NOT EXISTS price_history(
    id           INTEGER PRIMARY KEY AUTOINCREMENT,
    item_id      INTEGER NOT NULL,
    price        INTEGER,
    stock        INTEGER,
    crawl_status INTEGER NOT NULL DEFAULT 1,
    time         TIMESTAMP DEFAULT(DATETIME('now','localtime')),
    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS events(
    id             INTEGER PRIMARY KEY AUTOINCREMENT,
    item_id        INTEGER NOT NULL,
    event_type     TEXT NOT NULL,
    price          INTEGER,
    old_price      INTEGER,
    threshold_days INTEGER,
    created_at     TIMESTAMP DEFAULT(DATETIME('now','localtime')),
    notified       INTEGER NOT NULL DEFAULT 0,
    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

-- インデックス
CREATE INDEX IF NOT EXISTS idx_items_item_key ON items(item_key);
CREATE INDEX IF NOT EXISTS idx_price_history_item_id ON price_history(item_id);
CREATE INDEX IF NOT EXISTS idx_price_history_time ON price_history(time);
-- 複合インデックス: item_id + time でのクエリを高速化
CREATE INDEX IF NOT EXISTS idx_price_history_item_time ON price_history(item_id, time DESC);
CREATE INDEX IF NOT EXISTS idx_events_item_id ON events(item_id);
CREATE INDEX IF NOT EXISTS idx_events_created_at ON events(created_at);
CREATE INDEX IF NOT EXISTS idx_events_type ON events(event_type);
